## <font style="color:black;">思考问题</font>
+ <font style="color:black;">如何展示用户地址的完整转账记录？</font>
+ <font style="color:black;">交易所如何检测用户充值（USDT/ETH）？</font>

## <font style="color:black;">监听链上数据的方法</font>
<font style="color:black;">自建后端：从RPC API读取节点数据。</font>

+ <font style="color:black;">订阅（subscription）：实时推送。</font>
+ <font style="color:black;">扫块（轮询/poll/block scanning）：定期查询。</font>

<font style="color:black;">第三方服务：Alchemy、Infura等。</font>

<!-- 这是一张图片，ocr 内容为： -->
![](https://cdn.nlark.com/yuque/0/2026/png/21482780/1770294007531-527e202b-eb7d-4ff7-b8eb-210dbea2de19.png)



## <font style="color:black;">订阅机制</font>
+ <font style="color:black;">可订阅类型：newHeads（新块头）、logs（事件日志）、newPendingTransactions（待处理交易）。</font>

<!-- 这是一张图片，ocr 内容为： -->
![](https://cdn.nlark.com/yuque/0/2026/png/21482780/1770294346986-2f408d79-d679-4aac-9fd3-c7dffdc3c247.png)



+ <font style="color:black;">示例JSON RPC：</font>
    - <font style="color:black;">新块头：</font><font style="color:black;">{"jsonrpc": "2.0", "id": 1, "method": "eth_subscribe", "params": ["newHeads"]}</font><font style="color:black;">。</font>
    - <font style="color:black;">指定事件：</font><font style="color:black;">{"jsonrpc": "2.0", "id": 1, "method": "eth_subscribe", "params": ["logs", {"address": "0x8320fe7702b96808f7bbc0d4a888ed1468216cfd", "topics": ["0xd78a0cb8bb633d06981248b816e7bd33c2a35a6089241d099fa519e361cab902"]}] }</font><font style="color:black;">。</font>

### <font style="color:black;">Viem示例：</font>
client.watchBlocks / watchEvent / watchPendingTransactions

```javascript
const publicClient = createPublicClient({
  chain: foundry,
  transport: webSocket(process.env.RPC_URL!),
})
publicClient.watchBlocks({
  onBlock: async (block) => {
  }
}
```



### 订阅的一些问题
<font style="color:black;">• 可靠性问题： 可能会因为网络问题、节点问题等原因断开, 订阅断开，可能会错过一些事件</font>

<font style="color:black;">• 历史数据问题：只能获取到订阅开始后的新事件</font>

<font style="color:black;">• 性能开销：订阅（多的话）对节点压力大， 有些节点有限制</font>

## <font style="color:black;">扫块机制</font>
+ <font style="color:black;">优势：可靠、不遗漏数据、不依赖节点订阅功能。</font>
+ <font style="color:black;">RPC API：</font>
    - <font style="color:black;">区块：</font><font style="color:black;">eth_getBlockByHash</font><font style="color:black;">、</font><font style="color:black;">eth_getBlockByNumber</font><font style="color:black;">。</font>
    - <font style="color:black;">交易：</font><font style="color:black;">eth_getTransactionByHash</font><font style="color:black;">。</font>
    - <font style="color:black;">收据：</font><font style="color:black;">eth_getTransactionReceipt</font><font style="color:black;">。</font>
    - <font style="color:black;">日志：</font><font style="color:black;">eth_getLogs</font><font style="color:black;">（Viem: </font><font style="color:black;">getLogs</font><font style="color:black;">）。</font>
+ <font style="color:black;">节点服务商：Alchemy、Infura、QuickNode。</font>
+ <font style="color:black;">文档链接：</font>[<font style="color:black;background-color:transparent;">https://ethereum.org/en/developers/docs/apis/json-rpc/</font>](https://ethereum.org/en/developers/docs/apis/json-rpc/。)

<font style="color:black;background-color:transparent;"></font>

### <font style="color:black;">getLogs示例</font>
<font style="color:black;">获取所有事件</font>

```javascript
import { publicClient } from './client'
const logs = await publicClient.getLogs()
```

获取区块高度内所有事件

```javascript
import { publicClient } from './client'
const logs = await publicClient.getLogs({
  fromBlock: 16330000n,
  toBlock: 16330050n
})
```

获取指定合约的事件

```javascript
import { parseAbiItem } from 'viem'
const logs = await publicClient.getLogs({
  address: '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48',
  fromBlock: 16330000n,
  toBlock: 16330050n
})
```

获取指定合约、指定事件

```javascript
import { parseAbiItem } from 'viem'
const logs = await publicClient.getLogs({
  address: '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48',
  event: parseAbiItem('event Transfer(address indexed from, address indexed to, uint256 value)'),
  fromBlock: 16330000n,
  toBlock: 16330050n
})
```



获取指定合约、指定事件及指定参数

```javascript
import { parseAbiItem } from 'viem'
const logs = await publicClient.getLogs({
  address: '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48',
  event: parseAbiItem('event Transfer(address indexed from, address indexed to, uint256 value)'),
  args: {
  from: '0xd8da6bf26964af9d7eed9e03e53415d37aa96045',
  to: '0xa5cc3c03994db5b0d9a5eedd10cabab0813678ac'
  },
  fromBlock: 16330000n,
  toBlock: 16330050n
})
```



获取指定合约、指定事件及指定参数[数组]

```javascript
import { parseAbiItem } from 'viem'
const logs = await publicClient.getLogs({
  address: '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48',
  event: parseAbiItem('event Transfer(address indexed from, address indexed to, uint256 value)'),
  args: {
    // '0xd8da...' OR '0xa5cc...' OR '0xa152...'
    from: [
    '0xd8da6bf26964af9d7eed9e03e53415d37aa96045',
    '0xa5cc3c03994db5b0d9a5eedd10cabab0813678ac',
    '0xa152f8bb749c55e9943a3a0a3111d18ee2b3f94e',
    ],
  }
})
```



同时获取多个事件

```javascript
import { parseAbi } from 'viem'
const logs = await publicClient.getLogs({
  events: parseAbi([
  'event Approval(address indexed owner, address indexed sender, uint256 value)',
  'event Transfer(address indexed from, address indexed to, uint256 value)',
  ]),
})
```

[https://viem.sh/docs/actions/public/getLogs#arguments](https://viem.sh/docs/actions/public/getLogs#arguments)



## 作业
+ <font style="color:black;">后端：索引自己发行的ERC20 Token转账记录到数据库，提供RESTful接口查询地址转账记录。</font>
+ <font style="color:black;">前端：用户登录后，从后端查询并展示转账记录。</font>

[https://decert.me/quests/ae220513-c0cb-4d9b-873a-caee1d4b358e](https://decert.me/quests/ae220513-c0cb-4d9b-873a-caee1d4b358e)

